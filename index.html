<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
<title>SC Case Parser</title>
<link rel="icon" type="image/svg+xml" href="data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0iVVRGLTgiPz4KPHN2ZyB3aWR0aD0iNjQiIGhlaWdodD0iNjQiIHZpZXdCb3g9IjAgMCA2NCA2NCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KICA8Y2lyY2xlIGN4PSIzMi4wIiBjeT0iMzIuMCIgcj0iMzEuMCIgZmlsbD0iI2ZmZmZmZiIvPgogIDxjaXJjbGUgY3g9IjMyLjAiIGN5PSIzMi4wIiByPSIzMC4yMCIgZmlsbD0ibm9uZSIgc3Ryb2tlPSIjN0IzRjAwIiBzdHJva2Utd2lkdGg9IjEuMjAiLz4KICA8Y2lyY2xlIGN4PSIzMi4wIiBjeT0iMzIuMCIgcj0iMjguMjAiIGZpbGw9Im5vbmUiIHN0cm9rZT0iIzAwMzU4MCIgc3Ryb2tlLXdpZHRoPSIyLjgwIi8+CiAgPGNpcmNsZSBjeD0iMzIuMCIgY3k9IjMyLjAiIHI9IjI4LjAwIiBmaWxsPSJub25lIiBzdHJva2U9IiMwMDM1ODAiIHN0cm9rZS13aWR0aD0iMS4zMCIvPgogIDxsaW5lIHgxPSIzNy43NiIgeTE9IjMyLjAwIiB4Mj0iNTkuMDAiIHkyPSIzMi4wMCIgc3Ryb2tlPSIjMDAzNTgwIiBzdHJva2Utd2lkdGg9IjEuNDAiIHN0cm9rZS1saW5lY2FwPSJyb3VuZCIvPjxsaW5lIHgxPSIzNy41NiIgeTE9IjMzLjQ5IiB4Mj0iNTguMDgiIHkyPSIzOC45OSIgc3Ryb2tlPSIjMDAzNTgwIiBzdHJva2Utd2lkdGg9IjEuNDAiIHN0cm9rZS1saW5lY2FwPSJyb3VuZCIvPjxsaW5lIHgxPSIzNi45OSIgeTE9IjM0Ljg4IiB4Mj0iNTUuMzgiIHkyPSI0NS41MCIgc3Ryb2tlPSIjMDAzNTgwIiBzdHJva2Utd2lkdGg9IjEuNDAiIHN0cm9rZS1saW5lY2FwPSJyb3VuZCIvPjxsaW5lIHgxPSIzNi4wNyIgeTE9IjM2LjA3IiB4Mj0iNTEuMDkiIHkyPSI1MS4wOSIgc3Ryb2tlPSIjMDAzNTgwIiBzdHJva2Utd2lkdGg9IjEuNDAiIHN0cm9rZS1saW5lY2FwPSJyb3VuZCIvPjxsaW5lIHgxPSIzNC44OCIgeTE9IjM2Ljk5IiB4Mj0iNDUuNTAiIHkyPSI1NS4zOCIgc3Ryb2tlPSIjMDAzNTgwIiBzdHJva2Utd2lkdGg9IjEuNDAiIHN0cm9rZS1saW5lY2FwPSJyb3VuZCIvPjxsaW5lIHgxPSIzMy40OSIgeTE9IjM3LjU2IiB4Mj0iMzguOTkiIHkyPSI1OC4wOCIgc3Ryb2tlPSIjMDAzNTgwIiBzdHJva2Utd2lkdGg9IjEuNDAiIHN0cm9rZS1saW5lY2FwPSJyb3VuZCIvPjxsaW5lIHgxPSIzMi4wMCIgeTE9IjM3Ljc2IiB4Mj0iMzIuMDAiIHkyPSI1OS4wMCIgc3Ryb2tlPSIjMDAzNTgwIiBzdHJva2Utd2lkdGg9IjEuNDAiIHN0cm9rZS1saW5lY2FwPSJyb3VuZCIvPjxsaW5lIHgxPSIzMC41MSIgeTE9IjM3LjU2IiB4Mj0iMjUuMDEiIHkyPSI1OC4wOCIgc3Ryb2tlPSIjMDAzNTgwIiBzdHJva2Utd2lkdGg9IjEuNDAiIHN0cm9rZS1saW5lY2FwPSJyb3VuZCIvPjxsaW5lIHgxPSIyOS4xMiIgeTE9IjM2Ljk5IiB4Mj0iMTguNTAiIHkyPSI1NS4zOCIgc3Ryb2tlPSIjMDAzNTgwIiBzdHJva2Utd2lkdGg9IjEuNDAiIHN0cm9rZS1saW5lY2FwPSJyb3VuZCIvPjxsaW5lIHgxPSIyNy45MyIgeTE9IjM2LjA3IiB4Mj0iMTIuOTEiIHkyPSI1MS4wOSIgc3Ryb2tlPSIjMDAzNTgwIiBzdHJva2Utd2lkdGg9IjEuNDAiIHN0cm9rZS1saW5lY2FwPSJyb3VuZCIvPjxsaW5lIHgxPSIyNy4wMSIgeTE9IjM0Ljg4IiB4Mj0iOC42MiIgeTI9IjQ1LjUwIiBzdHJva2U9IiMwMDM1ODAiIHN0cm9rZS13aWR0aD0iMS40MCIgc3Ryb2tlLWxpbmVjYXA9InJvdW5kIi8+PGxpbmUgeDE9IjI2LjQ0IiB5MT0iMzMuNDkiIHgyPSI1LjkyIiB5Mj0iMzguOTkiIHN0cm9rZT0iIzAwMzU4MCIgc3Ryb2tlLXdpZHRoPSIxLjQwIiBzdHJva2UtbGluZWNhcD0icm91bmQiLz48bGluZSB4MT0iMjYuMjQiIHkxPSIzMi4wMCIgeDI9IjUuMDAiIHkyPSIzMi4wMCIgc3Ryb2tlPSIjMDAzNTgwIiBzdHJva2Utd2lkdGg9IjEuNDAiIHN0cm9rZS1saW5lY2FwPSJyb3VuZCIvPjxsaW5lIHgxPSIyNi40NCIgeTE9IjMwLjUxIiB4Mj0iNS45MiIgeTI9IjI1LjAxIiBzdHJva2U9IiMwMDM1ODAiIHN0cm9rZS13aWR0aD0iMS40MCIgc3Ryb2tlLWxpbmVjYXA9InJvdW5kIi8+PGxpbmUgeDE9IjI3LjAxIiB5MT0iMjkuMTIiIHgyPSI4LjYyIiB5Mj0iMTguNTAiIHN0cm9rZT0iIzAwMzU4MCIgc3Ryb2tlLXdpZHRoPSIxLjQwIiBzdHJva2UtbGluZWNhcD0icm91bmQiLz48bGluZSB4MT0iMjcuOTMiIHkxPSIyNy45MyIgeDI9IjEyLjkxIiB5Mj0iMTIuOTEiIHN0cm9rZT0iIzAwMzU4MCIgc3Ryb2tlLXdpZHRoPSIxLjQwIiBzdHJva2UtbGluZWNhcD0icm91bmQiLz48bGluZSB4MT0iMjkuMTIiIHkxPSIyNy4wMSIgeDI9IjE4LjUwIiB5Mj0iOC42MiIgc3Ryb2tlPSIjMDAzNTgwIiBzdHJva2Utd2lkdGg9IjEuNDAiIHN0cm9rZS1saW5lY2FwPSJyb3VuZCIvPjxsaW5lIHgxPSIzMC41MSIgeTE9IjI2LjQ0IiB4Mj0iMjUuMDEiIHkyPSI1LjkyIiBzdHJva2U9IiMwMDM1ODAiIHN0cm9rZS13aWR0aD0iMS40MCIgc3Ryb2tlLWxpbmVjYXA9InJvdW5kIi8+PGxpbmUgeDE9IjMyLjAwIiB5MT0iMjYuMjQiIHgyPSIzMi4wMCIgeTI9IjUuMDAiIHN0cm9rZT0iIzAwMzU4MCIgc3Ryb2tlLXdpZHRoPSIxLjQwIiBzdHJva2UtbGluZWNhcD0icm91bmQiLz48bGluZSB4MT0iMzMuNDkiIHkxPSIyNi40NCIgeDI9IjM4Ljk5IiB5Mj0iNS45MiIgc3Ryb2tlPSIjMDAzNTgwIiBzdHJva2Utd2lkdGg9IjEuNDAiIHN0cm9rZS1saW5lY2FwPSJyb3VuZCIvPjxsaW5lIHgxPSIzNC44OCIgeTE9IjI3LjAxIiB4Mj0iNDUuNTAiIHkyPSI4LjYyIiBzdHJva2U9IiMwMDM1ODAiIHN0cm9rZS13aWR0aD0iMS40MCIgc3Ryb2tlLWxpbmVjYXA9InJvdW5kIi8+PGxpbmUgeDE9IjM2LjA3IiB5MT0iMjcuOTMiIHgyPSI1MS4wOSIgeTI9IjEyLjkxIiBzdHJva2U9IiMwMDM1ODAiIHN0cm9rZS13aWR0aD0iMS40MCIgc3Ryb2tlLWxpbmVjYXA9InJvdW5kIi8+PGxpbmUgeDE9IjM2Ljk5IiB5MT0iMjkuMTIiIHgyPSI1NS4zOCIgeTI9IjE4LjUwIiBzdHJva2U9IiMwMDM1ODAiIHN0cm9rZS13aWR0aD0iMS40MCIgc3Ryb2tlLWxpbmVjYXA9InJvdW5kIi8+PGxpbmUgeDE9IjM3LjU2IiB5MT0iMzAuNTEiIHgyPSI1OC4wOCIgeTI9IjI1LjAxIiBzdHJva2U9IiMwMDM1ODAiIHN0cm9rZS13aWR0aD0iMS40MCIgc3Ryb2tlLWxpbmVjYXA9InJvdW5kIi8+CiAgPGNpcmNsZSBjeD0iMzIuMCIgY3k9IjMyLjAiIHI9IjcuNzYiIGZpbGw9IiM3QjNGMDAiLz4KICA8Y2lyY2xlIGN4PSIzMi4wIiBjeT0iMzIuMCIgcj0iNS43NiIgZmlsbD0iIzAwMzU4MCIvPgo8L3N2Zz4=">
<link rel="apple-touch-icon" href="data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0iVVRGLTgiPz4KPHN2ZyB3aWR0aD0iNjQiIGhlaWdodD0iNjQiIHZpZXdCb3g9IjAgMCA2NCA2NCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KICA8Y2lyY2xlIGN4PSIzMi4wIiBjeT0iMzIuMCIgcj0iMzEuMCIgZmlsbD0iI2ZmZmZmZiIvPgogIDxjaXJjbGUgY3g9IjMyLjAiIGN5PSIzMi4wIiByPSIzMC4yMCIgZmlsbD0ibm9uZSIgc3Ryb2tlPSIjN0IzRjAwIiBzdHJva2Utd2lkdGg9IjEuMjAiLz4KICA8Y2lyY2xlIGN4PSIzMi4wIiBjeT0iMzIuMCIgcj0iMjguMjAiIGZpbGw9Im5vbmUiIHN0cm9rZT0iIzAwMzU4MCIgc3Ryb2tlLXdpZHRoPSIyLjgwIi8+CiAgPGNpcmNsZSBjeD0iMzIuMCIgY3k9IjMyLjAiIHI9IjI4LjAwIiBmaWxsPSJub25lIiBzdHJva2U9IiMwMDM1ODAiIHN0cm9rZS13aWR0aD0iMS4zMCIvPgogIDxsaW5lIHgxPSIzNy43NiIgeTE9IjMyLjAwIiB4Mj0iNTkuMDAiIHkyPSIzMi4wMCIgc3Ryb2tlPSIjMDAzNTgwIiBzdHJva2Utd2lkdGg9IjEuNDAiIHN0cm9rZS1saW5lY2FwPSJyb3VuZCIvPjxsaW5lIHgxPSIzNy41NiIgeTE9IjMzLjQ5IiB4Mj0iNTguMDgiIHkyPSIzOC45OSIgc3Ryb2tlPSIjMDAzNTgwIiBzdHJva2Utd2lkdGg9IjEuNDAiIHN0cm9rZS1saW5lY2FwPSJyb3VuZCIvPjxsaW5lIHgxPSIzNi45OSIgeTE9IjM0Ljg4IiB4Mj0iNTUuMzgiIHkyPSI0NS41MCIgc3Ryb2tlPSIjMDAzNTgwIiBzdHJva2Utd2lkdGg9IjEuNDAiIHN0cm9rZS1saW5lY2FwPSJyb3VuZCIvPjxsaW5lIHgxPSIzNi4wNyIgeTE9IjM2LjA3IiB4Mj0iNTEuMDkiIHkyPSI1MS4wOSIgc3Ryb2tlPSIjMDAzNTgwIiBzdHJva2Utd2lkdGg9IjEuNDAiIHN0cm9rZS1saW5lY2FwPSJyb3VuZCIvPjxsaW5lIHgxPSIzNC44OCIgeTE9IjM2Ljk5IiB4Mj0iNDUuNTAiIHkyPSI1NS4zOCIgc3Ryb2tlPSIjMDAzNTgwIiBzdHJva2Utd2lkdGg9IjEuNDAiIHN0cm9rZS1saW5lY2FwPSJyb3VuZCIvPjxsaW5lIHgxPSIzMy40OSIgeTE9IjM3LjU2IiB4Mj0iMzguOTkiIHkyPSI1OC4wOCIgc3Ryb2tlPSIjMDAzNTgwIiBzdHJva2Utd2lkdGg9IjEuNDAiIHN0cm9rZS1saW5lY2FwPSJyb3VuZCIvPjxsaW5lIHgxPSIzMi4wMCIgeTE9IjM3Ljc2IiB4Mj0iMzIuMDAiIHkyPSI1OS4wMCIgc3Ryb2tlPSIjMDAzNTgwIiBzdHJva2Utd2lkdGg9IjEuNDAiIHN0cm9rZS1saW5lY2FwPSJyb3VuZCIvPjxsaW5lIHgxPSIzMC41MSIgeTE9IjM3LjU2IiB4Mj0iMjUuMDEiIHkyPSI1OC4wOCIgc3Ryb2tlPSIjMDAzNTgwIiBzdHJva2Utd2lkdGg9IjEuNDAiIHN0cm9rZS1saW5lY2FwPSJyb3VuZCIvPjxsaW5lIHgxPSIyOS4xMiIgeTE9IjM2Ljk5IiB4Mj0iMTguNTAiIHkyPSI1NS4zOCIgc3Ryb2tlPSIjMDAzNTgwIiBzdHJva2Utd2lkdGg9IjEuNDAiIHN0cm9rZS1saW5lY2FwPSJyb3VuZCIvPjxsaW5lIHgxPSIyNy45MyIgeTE9IjM2LjA3IiB4Mj0iMTIuOTEiIHkyPSI1MS4wOSIgc3Ryb2tlPSIjMDAzNTgwIiBzdHJva2Utd2lkdGg9IjEuNDAiIHN0cm9rZS1saW5lY2FwPSJyb3VuZCIvPjxsaW5lIHgxPSIyNy4wMSIgeTE9IjM0Ljg4IiB4Mj0iOC42MiIgeTI9IjQ1LjUwIiBzdHJva2U9IiMwMDM1ODAiIHN0cm9rZS13aWR0aD0iMS40MCIgc3Ryb2tlLWxpbmVjYXA9InJvdW5kIi8+PGxpbmUgeDE9IjI2LjQ0IiB5MT0iMzMuNDkiIHgyPSI1LjkyIiB5Mj0iMzguOTkiIHN0cm9rZT0iIzAwMzU4MCIgc3Ryb2tlLXdpZHRoPSIxLjQwIiBzdHJva2UtbGluZWNhcD0icm91bmQiLz48bGluZSB4MT0iMjYuMjQiIHkxPSIzMi4wMCIgeDI9IjUuMDAiIHkyPSIzMi4wMCIgc3Ryb2tlPSIjMDAzNTgwIiBzdHJva2Utd2lkdGg9IjEuNDAiIHN0cm9rZS1saW5lY2FwPSJyb3VuZCIvPjxsaW5lIHgxPSIyNi40NCIgeTE9IjMwLjUxIiB4Mj0iNS45MiIgeTI9IjI1LjAxIiBzdHJva2U9IiMwMDM1ODAiIHN0cm9rZS13aWR0aD0iMS40MCIgc3Ryb2tlLWxpbmVjYXA9InJvdW5kIi8+PGxpbmUgeDE9IjI3LjAxIiB5MT0iMjkuMTIiIHgyPSI4LjYyIiB5Mj0iMTguNTAiIHN0cm9rZT0iIzAwMzU4MCIgc3Ryb2tlLXdpZHRoPSIxLjQwIiBzdHJva2UtbGluZWNhcD0icm91bmQiLz48bGluZSB4MT0iMjcuOTMiIHkxPSIyNy45MyIgeDI9IjEyLjkxIiB5Mj0iMTIuOTEiIHN0cm9rZT0iIzAwMzU4MCIgc3Ryb2tlLXdpZHRoPSIxLjQwIiBzdHJva2UtbGluZWNhcD0icm91bmQiLz48bGluZSB4MT0iMjkuMTIiIHkxPSIyNy4wMSIgeDI9IjE4LjUwIiB5Mj0iOC42MiIgc3Ryb2tlPSIjMDAzNTgwIiBzdHJva2Utd2lkdGg9IjEuNDAiIHN0cm9rZS1saW5lY2FwPSJyb3VuZCIvPjxsaW5lIHgxPSIzMC41MSIgeTE9IjI2LjQ0IiB4Mj0iMjUuMDEiIHkyPSI1LjkyIiBzdHJva2U9IiMwMDM1ODAiIHN0cm9rZS13aWR0aD0iMS40MCIgc3Ryb2tlLWxpbmVjYXA9InJvdW5kIi8+PGxpbmUgeDE9IjMyLjAwIiB5MT0iMjYuMjQiIHgyPSIzMi4wMCIgeTI9IjUuMDAiIHN0cm9rZT0iIzAwMzU4MCIgc3Ryb2tlLXdpZHRoPSIxLjQwIiBzdHJva2UtbGluZWNhcD0icm91bmQiLz48bGluZSB4MT0iMzMuNDkiIHkxPSIyNi40NCIgeDI9IjM4Ljk5IiB5Mj0iNS45MiIgc3Ryb2tlPSIjMDAzNTgwIiBzdHJva2Utd2lkdGg9IjEuNDAiIHN0cm9rZS1saW5lY2FwPSJyb3VuZCIvPjxsaW5lIHgxPSIzNC44OCIgeTE9IjI3LjAxIiB4Mj0iNDUuNTAiIHkyPSI4LjYyIiBzdHJva2U9IiMwMDM1ODAiIHN0cm9rZS13aWR0aD0iMS40MCIgc3Ryb2tlLWxpbmVjYXA9InJvdW5kIi8+PGxpbmUgeDE9IjM2LjA3IiB5MT0iMjcuOTMiIHgyPSI1MS4wOSIgeTI9IjEyLjkxIiBzdHJva2U9IiMwMDM1ODAiIHN0cm9rZS13aWR0aD0iMS40MCIgc3Ryb2tlLWxpbmVjYXA9InJvdW5kIi8+PGxpbmUgeDE9IjM2Ljk5IiB5MT0iMjkuMTIiIHgyPSI1NS4zOCIgeTI9IjE4LjUwIiBzdHJva2U9IiMwMDM1ODAiIHN0cm9rZS13aWR0aD0iMS40MCIgc3Ryb2tlLWxpbmVjYXA9InJvdW5kIi8+PGxpbmUgeDE9IjM3LjU2IiB5MT0iMzAuNTEiIHgyPSI1OC4wOCIgeTI9IjI1LjAxIiBzdHJva2U9IiMwMDM1ODAiIHN0cm9rZS13aWR0aD0iMS40MCIgc3Ryb2tlLWxpbmVjYXA9InJvdW5kIi8+CiAgPGNpcmNsZSBjeD0iMzIuMCIgY3k9IjMyLjAiIHI9IjcuNzYiIGZpbGw9IiM3QjNGMDAiLz4KICA8Y2lyY2xlIGN4PSIzMi4wIiBjeT0iMzIuMCIgcj0iNS43NiIgZmlsbD0iIzAwMzU4MCIvPgo8L3N2Zz4=">
<meta name="theme-color" content="#1c1c1c">
<script>
// Load a script from multiple CDN fallbacks
function loadScript(urls, onDone) {
  var i = 0;
  function tryNext() {
    if (i >= urls.length) { onDone(false); return; }
    var s = document.createElement('script');
    s.src = urls[i++];
    s.onload = function() { onDone(true); };
    s.onerror = function() { tryNext(); };
    document.head.appendChild(s);
  }
  tryNext();
}

var _jspdfLoaded = false;
var _pdfjsLoaded = false;

loadScript([
  'https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js',
  'https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js',
  'https://unpkg.com/jspdf@2.5.1/dist/jspdf.umd.min.js'
], function(ok) { _jspdfLoaded = ok; });

loadScript([
  'https://cdn.jsdelivr.net/npm/pdfjs-dist@3.11.174/build/pdf.min.js',
  'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js',
  'https://unpkg.com/pdfjs-dist@3.11.174/build/pdf.min.js'
], function(ok) { _pdfjsLoaded = ok; });
</script>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap');

  :root {
    --bg: #111111;
    --surface: #1c1c1c;
    --surface2: #242424;
    --border: #2e2e2e;
    --border-light: #3a3a3a;
    --text: #f0f0f0;
    --muted: #888888;
    --muted2: #555555;
    --white: #ffffff;
  }

  * { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    background: var(--bg);
    color: var(--text);
    font-family: 'Inter', system-ui, sans-serif;
    min-height: 100vh;
    font-size: 14px;
    line-height: 1.5;
  }

  header {
    background: var(--surface);
    border-bottom: 1px solid var(--border);
    padding: 22px 24px;
    text-align: center;
  }

  .header-brand {
    display: inline-flex;
    align-items: center;
    gap: 12px;
    justify-content: center;
  }

  .ashok-chakra {
    flex-shrink: 0;
  }

  .header-text {
    text-align: left;
  }

  .logo {
    font-size: 1.05rem;
    font-weight: 600;
    color: var(--white);
    letter-spacing: 0.04em;
    line-height: 1.2;
  }

  .tagline {
    font-size: 0.72rem;
    color: var(--muted);
    margin-top: 3px;
    letter-spacing: 0.02em;
  }

  .main {
    max-width: 680px;
    margin: 0 auto;
    padding: 36px 24px 80px;
  }

  /* Upload area */
  .upload-zone {
    border: 1.5px dashed var(--border-light);
    border-radius: 8px;
    padding: 28px 20px;
    text-align: center;
    cursor: pointer;
    transition: border-color 0.15s, background 0.15s;
    position: relative;
    background: var(--surface);
  }

  .upload-zone:hover, .upload-zone.drag-over {
    border-color: var(--muted);
    background: var(--surface2);
  }

  .upload-zone input[type=file] {
    position: absolute;
    inset: 0;
    opacity: 0;
    cursor: pointer;
    width: 100%;
    height: 100%;
  }

  .upload-icon { font-size: 1.4rem; margin-bottom: 8px; display: block; }

  .upload-label { font-size: 0.82rem; color: var(--muted); }
  .upload-label strong { color: var(--text); font-weight: 500; }

  .upload-status {
    font-size: 0.78rem;
    margin-top: 10px;
    padding: 9px 13px;
    background: var(--surface2);
    border: 1px solid var(--border-light);
    border-radius: 6px;
    color: var(--text);
    display: none;
  }

  .divider {
    display: flex;
    align-items: center;
    gap: 12px;
    margin: 22px 0;
  }

  .divider::before, .divider::after {
    content: '';
    flex: 1;
    height: 1px;
    background: var(--border);
  }

  .divider-text { font-size: 0.7rem; color: var(--muted2); }

  textarea {
    width: 100%;
    min-height: 160px;
    background: var(--surface);
    border: 1.5px solid var(--border);
    border-radius: 8px;
    padding: 13px 15px;
    color: var(--text);
    font-family: 'Inter', system-ui, sans-serif;
    font-size: 0.82rem;
    line-height: 1.6;
    resize: vertical;
    outline: none;
    transition: border-color 0.15s;
  }

  textarea:focus { border-color: var(--muted); }
  textarea::placeholder { color: var(--muted2); }

  .parse-btn {
    width: 100%;
    padding: 13px;
    background: var(--white);
    color: #111;
    border: none;
    font-family: 'Inter', system-ui, sans-serif;
    font-size: 0.88rem;
    font-weight: 600;
    cursor: pointer;
    border-radius: 8px;
    margin-top: 16px;
    transition: background 0.15s;
    letter-spacing: 0.01em;
  }

  .parse-btn:hover { background: #e0e0e0; }
  .parse-btn:active { background: #cccccc; }

  .parse-btn:disabled {
    background: var(--surface2);
    color: var(--muted2);
    cursor: not-allowed;
  }

  .status-bar {
    font-size: 0.78rem;
    padding: 10px 14px;
    border-radius: 6px;
    margin-top: 12px;
    display: none;
    line-height: 1.5;
  }

  .status-bar.error {
    background: var(--surface2);
    border: 1px solid var(--border-light);
    color: #cc8888;
    display: block;
  }

  .status-bar.info {
    background: var(--surface2);
    border: 1px solid var(--border-light);
    color: var(--muted);
    display: block;
  }

  .processing {
    display: none;
    text-align: center;
    padding: 40px;
    color: var(--muted);
    font-size: 0.82rem;
  }

  .processing.visible { display: block; }

  .spinner {
    display: inline-block;
    width: 20px;
    height: 20px;
    border: 2px solid var(--border-light);
    border-top-color: var(--white);
    border-radius: 50%;
    animation: spin 0.7s linear infinite;
    margin-bottom: 10px;
  }

  @keyframes spin { to { transform: rotate(360deg); } }

  .results-section { display: none; margin-top: 36px; }
  .results-section.visible { display: block; }

  .stats-row {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 8px;
    margin-bottom: 28px;
  }

  .stat-box {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 16px;
    text-align: center;
  }

  .stat-num {
    font-size: 1.8rem;
    font-weight: 600;
    color: var(--white);
    line-height: 1;
    display: block;
  }

  .stat-label {
    font-size: 0.68rem;
    color: var(--muted);
    margin-top: 5px;
    text-transform: uppercase;
    letter-spacing: 0.07em;
  }

  .section-label {
    font-size: 0.68rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    color: var(--muted2);
    margin-bottom: 10px;
    margin-top: 4px;
  }

  .pdf-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(110px, 1fr));
    gap: 8px;
    margin-bottom: 10px;
  }

  .pdf-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 14px 10px;
    cursor: pointer;
    transition: border-color 0.15s, background 0.15s;
    display: flex;
    flex-direction: column;
    align-items: center;
  }

  .pdf-card:hover {
    border-color: var(--muted);
    background: var(--surface2);
  }

  .pdf-icon {
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 0 auto 10px;
    width: 44px;
    height: 44px;
    border-radius: 10px;
    background: var(--surface2);
    border: 1px solid var(--border-light);
    transition: border-color 0.15s;
  }
  .pdf-card:hover .pdf-icon {
    border-color: var(--muted);
  }
  .pdf-icon svg {
    display: block;
  }

  .pdf-name {
    font-size: 0.82rem;
    font-weight: 600;
    color: var(--text);
    white-space: nowrap;
    margin-bottom: 2px;
    max-width: 100%;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  .pdf-count { font-size: 0.66rem; color: var(--muted); }

  .download-all-btn {
    width: 100%;
    padding: 10px;
    background: transparent;
    color: var(--muted);
    border: 1px solid var(--border);
    font-family: 'Inter', system-ui, sans-serif;
    font-size: 0.76rem;
    cursor: pointer;
    border-radius: 8px;
    margin-bottom: 24px;
    transition: border-color 0.15s, color 0.15s;
  }

  .download-all-btn:hover { border-color: var(--muted); color: var(--text); }

  .modal-overlay {
    display: none;
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.7);
    z-index: 10000;
    align-items: center;
    justify-content: center;
    padding: 16px;
  }

  .modal-overlay.open { display: flex; }

  .modal {
    background: var(--surface);
    border: 1px solid var(--border-light);
    border-radius: 10px;
    width: 100%;
    max-width: 860px;
    max-height: 92vh;
    display: flex;
    flex-direction: column;
    overflow: hidden;
    box-shadow: 0 12px 48px rgba(0,0,0,0.6);
  }

  .modal-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 14px 18px;
    border-bottom: 1px solid var(--border);
    gap: 10px;
    flex-shrink: 0;
  }

  .modal-title {
    font-size: 0.88rem;
    font-weight: 600;
    color: var(--white);
  }

  .modal-actions { display: flex; gap: 8px; flex-shrink: 0; }

  .modal-btn {
    padding: 7px 14px;
    border-radius: 6px;
    font-family: 'Inter', system-ui, sans-serif;
    font-size: 0.76rem;
    font-weight: 500;
    cursor: pointer;
    border: 1px solid var(--border-light);
    transition: all 0.15s;
  }

  .modal-btn.download {
    background: var(--white);
    color: #111;
    border-color: var(--white);
  }
  .modal-btn.download:hover { background: #e0e0e0; }

  .modal-btn.close {
    background: transparent;
    color: var(--muted);
  }
  .modal-btn.close:hover { color: var(--text); border-color: var(--muted); }

  .modal-body {
    flex: 1;
    overflow: hidden;
    position: relative;
    background: #2a2a2a;
  }

  .modal-body iframe {
    width: 100%;
    height: 100%;
    border: none;
    min-height: 60vh;
  }

  .modal-loading {
    position: absolute;
    inset: 0;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: 10px;
    font-size: 0.78rem;
    color: var(--muted);
  }

  footer {
    text-align: center;
    padding: 24px 20px;
    font-size: 0.7rem;
    color: var(--muted2);
    border-top: 1px solid var(--border);
  }

  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(5px); }
    to { opacity: 1; transform: translateY(0); }
  }

  .results-section.visible .pdf-card {
    animation: fadeIn 0.2s ease forwards;
  }
</style>
</head>
<body>

<header>
  <div class="header-brand">
    <svg class="ashok-chakra" width="48" height="48" viewBox="0 0 48 48" xmlns="http://www.w3.org/2000/svg">
  <!-- Outer rim -->
  <circle cx="24.0" cy="24.0" r="23.0" fill="none" stroke="#003580" stroke-width="3"/>
  <!-- Inner rim -->
  <circle cx="24.0" cy="24.0" r="20.0" fill="none" stroke="#003580" stroke-width="1.2"/>
  <!-- 24 spokes -->
  <line x1="28.32" y1="24.00" x2="43.00" y2="24.00" stroke="#003580" stroke-width="1.1" stroke-linecap="round"/><line x1="28.17" y1="25.12" x2="42.35" y2="28.92" stroke="#003580" stroke-width="1.1" stroke-linecap="round"/><line x1="27.74" y1="26.16" x2="40.45" y2="33.50" stroke="#003580" stroke-width="1.1" stroke-linecap="round"/><line x1="27.05" y1="27.05" x2="37.44" y2="37.44" stroke="#003580" stroke-width="1.1" stroke-linecap="round"/><line x1="26.16" y1="27.74" x2="33.50" y2="40.45" stroke="#003580" stroke-width="1.1" stroke-linecap="round"/><line x1="25.12" y1="28.17" x2="28.92" y2="42.35" stroke="#003580" stroke-width="1.1" stroke-linecap="round"/><line x1="24.00" y1="28.32" x2="24.00" y2="43.00" stroke="#003580" stroke-width="1.1" stroke-linecap="round"/><line x1="22.88" y1="28.17" x2="19.08" y2="42.35" stroke="#003580" stroke-width="1.1" stroke-linecap="round"/><line x1="21.84" y1="27.74" x2="14.50" y2="40.45" stroke="#003580" stroke-width="1.1" stroke-linecap="round"/><line x1="20.95" y1="27.05" x2="10.56" y2="37.44" stroke="#003580" stroke-width="1.1" stroke-linecap="round"/><line x1="20.26" y1="26.16" x2="7.55" y2="33.50" stroke="#003580" stroke-width="1.1" stroke-linecap="round"/><line x1="19.83" y1="25.12" x2="5.65" y2="28.92" stroke="#003580" stroke-width="1.1" stroke-linecap="round"/><line x1="19.68" y1="24.00" x2="5.00" y2="24.00" stroke="#003580" stroke-width="1.1" stroke-linecap="round"/><line x1="19.83" y1="22.88" x2="5.65" y2="19.08" stroke="#003580" stroke-width="1.1" stroke-linecap="round"/><line x1="20.26" y1="21.84" x2="7.55" y2="14.50" stroke="#003580" stroke-width="1.1" stroke-linecap="round"/><line x1="20.95" y1="20.95" x2="10.56" y2="10.56" stroke="#003580" stroke-width="1.1" stroke-linecap="round"/><line x1="21.84" y1="20.26" x2="14.50" y2="7.55" stroke="#003580" stroke-width="1.1" stroke-linecap="round"/><line x1="22.88" y1="19.83" x2="19.08" y2="5.65" stroke="#003580" stroke-width="1.1" stroke-linecap="round"/><line x1="24.00" y1="19.68" x2="24.00" y2="5.00" stroke="#003580" stroke-width="1.1" stroke-linecap="round"/><line x1="25.12" y1="19.83" x2="28.92" y2="5.65" stroke="#003580" stroke-width="1.1" stroke-linecap="round"/><line x1="26.16" y1="20.26" x2="33.50" y2="7.55" stroke="#003580" stroke-width="1.1" stroke-linecap="round"/><line x1="27.05" y1="20.95" x2="37.44" y2="10.56" stroke="#003580" stroke-width="1.1" stroke-linecap="round"/><line x1="27.74" y1="21.84" x2="40.45" y2="14.50" stroke="#003580" stroke-width="1.1" stroke-linecap="round"/><line x1="28.17" y1="22.88" x2="42.35" y2="19.08" stroke="#003580" stroke-width="1.1" stroke-linecap="round"/>
  <!-- Hub outer ring (brown) -->
  <circle cx="24.0" cy="24.0" r="5.82" fill="#7B3F00" stroke="none"/>
  <!-- Hub inner (blue) -->
  <circle cx="24.0" cy="24.0" r="4.32" fill="#003580" stroke="none"/>
</svg>
    <div class="header-text">
      <div class="logo">SC Case Parser</div>
      <div class="tagline">Supreme Court of India â€” Daily Cause List</div>
    </div>
  </div>
</header>

<div class="main">

  <div class="upload-zone" id="uploadZone">
      <input type="file" accept=".pdf,.txt" id="fileInput" />
      <span class="upload-icon">ðŸ“„</span>
      <div class="upload-label"><strong>Tap to upload</strong> PDF or TXT</div>
      <div class="upload-label" style="margin-top:4px;font-size:0.65rem;">or drag and drop</div>
    </div>
  <div class="upload-status" id="uploadStatus"></div>

  <div class="divider"><span class="divider-text">or paste text below</span></div>

  <textarea id="textInput" placeholder="Paste cause list text here..."></textarea>

  <button class="parse-btn" id="parseBtn" onclick="runParse()">Parse &amp; Generate PDFs</button>

  <div class="status-bar" id="statusBar"></div>

  <div class="processing" id="processing">
    <div class="spinner"></div><br>Processing...
  </div>

  <!-- Results -->
  <div class="results-section" id="results">

    <div class="stats-row">
      <div class="stat-box">
        <span class="stat-num" id="statCases">0</span>
        <div class="stat-label">Total Cases</div>
      </div>
      <div class="stat-box">
        <span class="stat-num" id="statCourts">0</span>
        <div class="stat-label">Courts</div>
      </div>
      <div class="stat-box">
        <span class="stat-num" id="statGodowns">0</span>
        <div class="stat-label">Godowns</div>
      </div>
    </div>

    <div class="section-label">By Court</div>
    <div class="pdf-grid" id="courtGrid"></div>
    <button class="download-all-btn" onclick="downloadAll('court')">Download all court PDFs</button>

    <div class="section-label">By Godown</div>
    <div class="pdf-grid" id="godownGrid"></div>
    <button class="download-all-btn" onclick="downloadAll('godown')">Download all godown PDFs</button>

  </div>

</div>

<footer>SC Case Parser Â· For internal use Â· Supreme Court of India</footer>

<!-- PDF Preview Modal -->
<div class="modal-overlay" id="modalOverlay" onclick="closeModalOnOverlay(event)">
  <div class="modal">
    <div class="modal-header">
      <div class="modal-title" id="modalTitle">COURT 1</div>
      <div class="modal-actions">
        <button class="modal-btn download" id="modalDownloadBtn" onclick="modalDownload()">Download PDF</button>
        <button class="modal-btn close" onclick="closeModal()">Close</button>
      </div>
    </div>
    <div class="modal-body">
      <div class="modal-loading" id="modalLoading">
        <div class="spinner"></div>
        Rendering PDF...
      </div>
      <iframe id="modalIframe" style="display:none;"></iframe>
    </div>
  </div>
</div>

<script>
// â”€â”€â”€ State â”€â”€â”€
let parsedCourts = {};
let parsedGodowns = {};
let documentDate = '';

// â”€â”€â”€ File upload â”€â”€â”€
const fileInput = document.getElementById('fileInput');
const uploadStatus = document.getElementById('uploadStatus');
const textInput = document.getElementById('textInput');

fileInput.addEventListener('change', async (e) => {
  const file = e.target.files[0];
  if (!file) return;
  uploadStatus.style.display = 'block';
  uploadStatus.textContent = `â³ Reading ${file.name}...`;
  try {
    let text = '';
    if (file.name.endsWith('.pdf')) {
      text = await extractPDFText(file);
    } else {
      text = await file.text();
    }
    textInput.value = text;
    uploadStatus.textContent = `âœ“ Loaded: ${file.name} (${text.length.toLocaleString()} chars)`;
    uploadStatus.style.color = 'var(--success)';
  } catch(err) {
    uploadStatus.textContent = `âœ— Error reading file: ${err.message}`;
    uploadStatus.style.color = 'var(--danger)';
  }
});

// Drag & drop
const uploadZone = document.getElementById('uploadZone');
uploadZone.addEventListener('dragover', e => { e.preventDefault(); uploadZone.classList.add('drag-over'); });
uploadZone.addEventListener('dragleave', () => uploadZone.classList.remove('drag-over'));
uploadZone.addEventListener('drop', async e => {
  e.preventDefault();
  uploadZone.classList.remove('drag-over');
  const file = e.dataTransfer.files[0];
  if (file) { fileInput.files = e.dataTransfer.files; fileInput.dispatchEvent(new Event('change')); }
});

async function extractPDFText(file) {
  if (typeof pdfjsLib === 'undefined') {
    throw new Error(
      'PDF.js could not load (Brave Shields may be blocking it). ' +
      'Please copy-paste the text from your PDF instead, or disable Brave Shields for this page.'
    );
  }
  // Set worker source here, safely, only when actually needed
  try {
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
  } catch(e) { /* non-fatal if already set */ }

  const arrayBuffer = await file.arrayBuffer();
  const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
  let fullText = '';
  for (let i = 1; i <= pdf.numPages; i++) {
    const page = await pdf.getPage(i);
    const content = await page.getTextContent();
    // Preserve line structure by grouping items by their Y position
    const items = content.items;
    if (items.length === 0) continue;
    const lineMap = new Map();
    for (const item of items) {
      const y = Math.round(item.transform[5]);
      if (!lineMap.has(y)) lineMap.set(y, []);
      lineMap.get(y).push(item.str);
    }
    // Sort lines top-to-bottom (higher Y = higher on page in PDF coords)
    const sortedYs = [...lineMap.keys()].sort((a, b) => b - a);
    for (const y of sortedYs) {
      fullText += lineMap.get(y).join(' ') + '\n';
    }
  }
  return fullText;
}

// â”€â”€â”€ CASE TYPES â”€â”€â”€
const CASE_TYPES = [
  [/R\.P\.?\s*\(\s*C\s*\)/i,                     "RP(C)"],
  [/R\.P\.?\s*\(\s*Crl\s*\)/i,                   "RP(Crl)"],
  [/\bR\.P\./i,                                   "RP"],
  [/Crl\.?\s*Misc\.?\s*Pet(?:ition)?\.?/i,       "CrlMP"],
  [/Crl\.?\s*M\.?P\./i,                           "CrlMP"],
  [/\bC\.C\./i,                                   "CC"],
  [/\bCC\b/i,                                     "CC"],
  [/Certified\s*Copy/i,                            "CC"],
  [/ARBIT\.?\s*PET(?:I?TION)?\.?/i,              "AP"],
  [/CONMT\.?\s*PET\.?\s*\(\s*C\s*\)/i,           "CP(C)"],
  [/CONMT\.?\s*PET\.?\s*\(\s*Crl\s*\)/i,         "CP(Crl)"],
  [/S\.?L\.?P\.?\s*\(\s*Crl\s*\)/i,              "SR"],
  [/S\.?L\.?P\.?\s*\(\s*C\s*\)/i,                "SC"],
  [/S\.?L\.?P\.?/i,                               "SLP"],
  [/W\.?P\.?\s*\(\s*Crl\.?\s*\)/i,               "WR"],
  [/W\.?P\.?\s*\(\s*C\s*\)/i,                    "WC"],
  [/T\.?P\.?\s*\(\s*Crl\.?\s*\)/i,               "TR"],
  [/T\.?P\.?\s*\(\s*C\s*\)/i,                    "TP"],
  [/T\.?C\.?\s*\(\s*C\s*\)/i,                    "TC(C)"],
  [/Crl\.?\s*App(?:eal)?\.?/i,                   "AR"],
  [/\bTP\b/i,                                    "TP"],
  [/\bTR\b/i,                                    "TR"],
  [/\bSR\b/i,                                    "SR"],
  [/\bSC\b/i,                                    "SC"],
  [/\bWC\b/i,                                    "WC"],
  [/\bWR\b/i,                                    "WR"],
  [/\bIA\s+/i,                                    "IA"],
  [/\bI\.A\./i,                                   "IA"],
  [/\bMA\s+/i,                                    "MA"],
  [/\bM\.A\./i,                                   "MA"],
  [/Crl\.?\s*A\./i,                               "AR"],
  [/Crl\.?\s*P\./i,                               "CP"],
  [/Crl\.?\s*Rv\./i,                              "CRv"],
  [/Crl\.?\s*Rev\./i,                             "CRev"],
  [/\bC\.A\./i,                                   "CA"],
  [/\bT\.A\./i,                                   "TA"],
  [/\bT\.P\./i,                                   "TP"],
  [/Tr\.?\s*Pet(?:ition)?\.?/i,                  "TP"],
  [/Trans\.?\s*Pet(?:ition)?\.?/i,               "TP"],
  [/Sp\.?\s*L\.?\s*P\./i,                        "SLP"],
  [/Sp\.?\s*L\.?\s*A\./i,                        "SLA"],
  [/Review\s*Pet(?:ition)?\.?/i,                 "RP"],
  [/Curative\s*Pet(?:ition)?\.?/i,               "CuP"],
  [/Contempt\s*Pet(?:ition)?\.?/i,               "CoP"],
  [/Elec\.?\s*Pet(?:ition)?\.?/i,                "EP"],
  [/\bP\.I\.L\./i,                               "PIL"],
  [/\bPIL\b/i,                                   "PIL"],
  [/Misc\.?\s*A\./i,                             "MA"],
  [/Misc\.?\s*P\./i,                             "MP"],
  [/\bA\.O\./i,                                  "AO"],
  [/Arb\.?\s*P\./i,                              "AP"],
  [/\bE\.P\./i,                                  "EP"],
  [/\bO\.A\./i,                                  "OA"],
  [/\bO\.S\./i,                                  "OS"],
  [/\bSuit\b/i,                                  "Suit"],
  [/Diary\s*No\./i,                              "D"],
  [/\bRef\./i,                                   "Ref"],
];

function detectCaseType(text) {
  // Stop at party name indicators so "IA No." buried in party text doesn't match
  for (const stopPat of [/\bVersus\b/i, /\bFOR\s+ADMISSION\b/i]) {
    const ms = text.search(stopPat);
    if (ms !== -1) text = text.slice(0, ms);
  }
  for (const [pat, label] of CASE_TYPES) {
    const m = text.match(pat);
    if (m) return [label, m.index + m[0].length];
  }
  return ["Unknown", null];
}

function extractCaseNumber(text, typeEnd) {
  const afterFull = text.slice(typeEnd);
  let cutoff = afterFull.length;
  for (const stopPat of [/\bVersus\b/i, /\bFOR\s+ADMISSION\b/i, /\bIA\s+No\./i]) {
    const ms = afterFull.search(stopPat);
    if (ms !== -1 && ms < cutoff) cutoff = ms;
  }
  // Extend cutoff to include any number/year appended after party name
  const mAfterCut = afterFull.slice(cutoff).match(/\d+(?:-\d+)?\/\d{4}/);
  if (mAfterCut) {
    const idx = afterFull.slice(cutoff).indexOf(mAfterCut[0]);
    cutoff = cutoff + idx + mAfterCut[0].length;
  }
  const after = afterFull.slice(0, cutoff);
  let m;
  // Range with No. â€” store only first number (e.g. 1234-1239 â†’ 1234)
  m = after.match(/No\.?\s*([\d]+)-[\d]+\s*\/\s*(\d{4})/);
  if (m) { const first = parseInt(m[1]); return [first, `${m[1]}/${m[2]}`, m[2]]; }
  // No. single
  m = after.match(/No\.?\s*(\d+)\s*\/\s*(\d{4})/);
  if (m) return [parseInt(m[1]), `${m[1]}/${m[2]}`, m[2]];
  // No. dash year
  m = after.match(/No\.?\s*(\d+)\s*-\s*(\d{4})/);
  if (m) return [parseInt(m[1]), `${m[1]}/${m[2]}`, m[2]];
  // OF
  m = after.match(/No\.?\s*(\d+)\s+OF\s+(\d{4})/i);
  if (m) return [parseInt(m[1]), `${m[1]}/${m[2]}`, m[2]];
  // Bare range anywhere (e.g. "1105-1106/2016") â€” store only first number
  m = after.match(/\b(\d{3,6})-\d{3,6}\s*\/\s*(\d{4})\b/);
  if (m) { const first = parseInt(m[1]); return [first, `${m[1]}/${m[2]}`, m[2]]; }
  // Bare single number/year anywhere
  m = after.match(/\b(\d{3,6})\s*\/\s*(\d{4})\b/);
  if (m) return [parseInt(m[1]), `${m[1]}/${m[2]}`, m[2]];
  // Bare number-year
  m = after.match(/\b(\d{3,6})\s*-\s*(\d{4})\b/);
  if (m) return [parseInt(m[1]), `${m[1]}/${m[2]}`, m[2]];
  return [0, "Unknown", "Unknown"];
}

function detectCourt(line) {
  const t = line.trim().toUpperCase();
  if (/CHIEF\s+JUSTICE/.test(t)) return 1;
  const m = t.match(/COURT\s*(?:NO\.?|NUMBER)\s*:?\s*(\d+)/);
  if (m) return parseInt(m[1]);
  return null;
}

function extractDate(raw) {
  const lines = raw.split('\n').slice(0, 20);
  for (const line of lines) {
    const m = line.match(/DAILY\s+CAUSE\s+LIST\s+FOR\s+DATED\s*:\s*(\d{2}[-/]\d{2}[-/]\d{4})/i);
    if (m) return m[1].replace(/\//g, '-');
  }
  return new Date().toLocaleDateString('en-IN').replace(/\//g, '-');
}

// â”€â”€â”€ Nested case detector â”€â”€â”€
function detectNestedCase(text) {
  // Truncate before party names / IA lines to prevent false matches
  for (const stopPat of [/\bVersus\b/i, /\bIA\s+No\./i, /\bFOR\s+ADMISSION\b/i]) {
    const ms = text.search(stopPat);
    if (ms !== -1) text = text.slice(0, ms);
  }
  if (!/\bin\b/i.test(text)) return null;
  for (const m_in of [...text.matchAll(/\bin\b/gi)]) {
    const left  = text.slice(0, m_in.index).trim();
    const right = text.slice(m_in.index + m_in[0].length).trim();

    // find rightmost number on left
    let outerNumYearRaw = null, outerTypeText = null;
    for (const mm of [...left.matchAll(/(?:No\.?\s*)?\d+(?:-\d+)?\/\d{4}/gi)]) {
      outerNumYearRaw = mm[0];
      outerTypeText = left.slice(0, mm.index).trim();
    }
    if (!outerNumYearRaw) continue;

    // find leftmost number on right
    const m2 = right.match(/(?:No\.?\s*)?(\d+(?:-\d+)?\/\d{4})/i);
    if (!m2) continue;
    const innerNumYear = m2[1];
    const innerTypeText = right.slice(0, m2.index).trim();

    // match types â€” strip trailing "No." artifact from innerTypeText
    let outerType = null, innerType = null;
    const outerUp = outerTypeText.replace(/\s*No\.?\s*$/i, '').trim().toUpperCase();
    const innerUp = innerTypeText.replace(/\s*No\.?\s*$/i, '').trim().toUpperCase();
    for (const [, label] of CASE_TYPES) {
      if (label.toUpperCase() === outerUp && !outerType) outerType = label;
      if (label.toUpperCase() === innerUp && !innerType) innerType = label;
    }
    for (const [pat, label] of CASE_TYPES) {
      if (!outerType && pat.test(outerTypeText)) outerType = label;
      if (!innerType && pat.test(innerTypeText)) innerType = label;
    }
    if (!outerType || !innerType) continue;

    const mOuter = outerNumYearRaw.match(/(\d+)(?:-\d+)?\/(\d{4})/);
    if (!mOuter) continue;
    const mInner = innerNumYear.match(/(\d+)(?:-\d+)?\/(\d{4})/);
    if (!mInner) continue;

    return {
      outerType, outerNum: parseInt(mOuter[1]), outerYear: mOuter[2],
      innerType, innerNum: mInner[1], innerYear: mInner[2]
    };
  }
  return null;
}

// â”€â”€â”€ Line joiner â”€â”€â”€
const CASE_KW_JS = /(?:MA\b|M\.A\.|S\.L\.P|SLP\s*\(|C\.A\.|W\.P\.|WP\s*\(|T\.P\.|TP\s*\(|Crl\.|C\.C\.|CC\b|ARBIT\b|CONMT\b|R\.P\.|RP\b|Sp\.L|PIL(?!-[WC])\b|Misc\.|Diary\s+No\.|Review\s+Pet|Curative\s+Pet|Contempt\s+Pet|Elec\.|Arb\.|Trans\s+Pet)/i;
const SECTION_ONLY_JS = /^(?:PIL-W|PIL-C|I{1,3}|IV|V|VI{1,3}|IX|X{1,3}|XI{1,3}|XIV|XV|XVI{1,3}|XIX|XX)(?:-[A-Z])?$/i;

function splitStackedItems(line) {
  // Handle "3 4 5 6 ARBIT... WP... Diary..." â€” multiple item numbers before case types
  const mStacked = line.match(/^((?:\d+\s+){2,})/);
  if (!mStacked) return [line];
  const itemNums = mStacked[1].trim().split(/\s+/);
  const rest = line.slice(mStacked[0].length);
  if (!CASE_KW_JS.test(rest)) return [line];

  // Split rest on case-type keyword boundaries
  const parts = rest.split(/(?=\s(?:MA\b|M\.A\.|S\.L\.P|SLP\s*\(|C\.A\.|W\.P\.|WP\s*\(|T\.P\.|TP\s*\(|Crl\.|C\.C\.|CC\b|ARBIT\b|CONMT\b|R\.P\.|RP\b|PIL(?!-[WC])\b|Misc\.|Diary\s+No\.))/i)
    .map(p => p.trim()).filter(Boolean);

  // Merge section-only fragments onto previous part
  const merged = [];
  for (const part of parts) {
    if (SECTION_ONLY_JS.test(part) && merged.length > 0) {
      merged[merged.length - 1] += ' ' + part;
    } else {
      merged.push(part);
    }
  }

  // Only keep parts that start with a known case keyword (discard party name trailing text)
  const result = [];
  let lastNum = parseInt(itemNums[itemNums.length - 1]) || 0;
  for (let i = 0; i < merged.length; i++) {
    if (!CASE_KW_JS.test(merged[i])) break;
    const num = i < itemNums.length ? itemNums[i] : String(++lastNum);
    result.push(num + ' ' + merged[i]);
  }
  return result.length > 0 ? result : [line];
}

function joinLines(raw) {
  // First handle stacked item numbers per line
  const stackedProcessed = [];
  for (const line of raw.split('\n')) {
    const expanded = splitStackedItems(line.trim());
    stackedProcessed.push(...expanded);
  }
  raw = stackedProcessed.join('\n');

  // Join: item has "No." + party name, next line is bare case number (PDF format)
  // e.g. "1    Crl.A. No.  ANITABEN..."  +  "1105-1106/2016  SANJANWALA..."
  {
    const linesArr = raw.split('\n');
    const out = [];
    for (let i = 0; i < linesArr.length; i++) {
      const prev = out.length > 0 ? out[out.length-1].trim() : '';
      const s = linesArr[i].trim();
      if (prev && /^\d+(?:\.\d+)?\s+(?:Connected\s+)?/.test(prev) &&
          /No\.\s*\S/.test(prev) && /^\d+(?:-\d+)?[\/]\d{4}/.test(s) &&
          !/\d+[\/\-]\d{4}/.test(prev)) {
        out[out.length-1] = out[out.length-1].trimEnd() + ' ' + s;
        continue;
      }
      // Join section-inline lines: "     II   ANANTHA BABU" where section is at start
      // (handled by section detector now, no join needed)
      out.push(linesArr[i]);
    }
    raw = out.join('\n');
  }

  // Then split standard run-on cases
  raw = raw.replace(
    /(?<!\d)(\s+)(\d+(?:\.\d+)?)(\s+(?:Connected\s+)?)(?=(?:MA\b|M\.A\.|S\.L\.P|SLP|C\.A\.|W\.P|WP|T\.P|TP|Crl|C\.C\.|CC|ARBIT|CONMT|R\.P|RP|Sp\.L|PIL|Misc|Diary|Review|Curative|Contempt|Elec|Arb|Trans|Tr\.)\b)/gi,
    (_, _sp, num, sp2) => '\n' + num + sp2
  );

  const lines = raw.split('\n');
  const joined = [];
  for (const line of lines) {
    const s = line.trim();
    if (!s) { joined.push(''); continue; }
    if (joined.length > 0) {
      const prev = joined[joined.length - 1].trim();
      // ends with No.
      if (/No\.\s*$/.test(prev) && /^\d+(?:-\d+)?[-/]\d{4}/.test(s)) {
        joined[joined.length - 1] = joined[joined.length - 1].trimEnd() + ' ' + s;
        continue;
      }
      // PDF format: item has "No." + party name inline, next line is bare case number
      // e.g. "1    Crl.A. No.  ANITABEN BABUBHAI AND ANR."  +  "1105-1106/2016   SANJANWALA"
      // e.g. "5    SLP(Crl) No.  ALI SABRIN"                +  "11838/2024"
      if (/^\d+(?:\.\d+)?\s+(?:Connected\s+)?/.test(prev) &&
          /No\.\s*\S/.test(prev) &&
          /^\d+(?:-\d+)?[\/]\d{4}/.test(s) &&
          !/\d+[\/\-]\d{4}/.test(prev)) {
        joined[joined.length - 1] = joined[joined.length - 1].trimEnd() + ' ' + s;
        continue;
      }
      // item + type, next is No. XXXX
      if (/^\d+(?:\.\d+)?\s+(?:Connected\s+)?.+/.test(prev) && /^No\.\s*\d+/.test(s)) {
        if (!/\d+\/\d{4}/.test(prev) && !/\d+-\d+\/\d{4}/.test(prev)) {
          joined[joined.length - 1] = joined[joined.length - 1].trimEnd() + ' ' + s;
          continue;
        }
      }
      // ends with " in"
      if (/\bin\s*$/.test(prev)) {
        joined[joined.length - 1] = joined[joined.length - 1].trimEnd() + ' ' + s;
        continue;
      }
      // prev is a complete case line, next starts with "in " (e.g. "in C.A. No.")
      if (/\d+[-â€“]?\d*\/\d{4}/.test(prev) && /^in\s+/i.test(s)) {
        joined[joined.length - 1] = joined[joined.length - 1].trimEnd() + ' ' + s;
        continue;
      }
      // ends with case type abbreviation (dotted or with parens), next is No.
      if (/(?:\b(?:C\.A\.|S\.L\.P\.?|Crl\.A\.|W\.P\.|T\.P\.|C\.C\.|R\.P\.|M\.A\.)|[A-Za-z]\([A-Za-z]+\))\s*$/.test(prev) && /^No\.\s*\d+/.test(s)) {
        joined[joined.length - 1] = joined[joined.length - 1].trimEnd() + ' ' + s;
        continue;
      }
      // split sub-numbers
      if (/^\d+\.\s*$/.test(prev) && /^[1-5]\s*$/.test(s)) {
        joined[joined.length - 1] = joined[joined.length - 1].trimEnd() + s;
        continue;
      }
      if (/^\d+\.\s*[1-5]\s*$/.test(prev) && s.toLowerCase() === 'connected') {
        joined[joined.length - 1] = joined[joined.length - 1].trimEnd() + ' ' + s;
        continue;
      }
      if (/^\d+\.\d+\s+Connected\s*$/.test(prev)) {
        joined[joined.length - 1] = joined[joined.length - 1].trimEnd() + ' ' + s;
        continue;
      }
      // Connected sub-item where party name appears on same line as "Connected"
      // and the case type is on the next line
      // e.g. "7.1   Connected  AMANDEEP"  +  "SLP(Crl) No."
      if (/^\d+\.\d+\s+Connected\b/.test(prev) && !joined[joined.length-1].match(/\d+[\/\-]\d{4}/)) {
        if (/(?:SLP|S\.L\.P|Crl\.?A|W\.P|T\.P|C\.A|M\.A|Diary|CONMT|ARBIT)\b/i.test(s)) {
          joined[joined.length - 1] = joined[joined.length - 1].trimEnd() + ' ' + s;
          continue;
        }
      }
    }
    joined.push(line);
  }
  return joined;
}

// â”€â”€â”€ Godown assignment â”€â”€â”€
function assignGodown(type, year, section) {
  const y = parseInt(year) || 0;
  if (type === "CC") return "RAM";
  if (type === "CrlMP" && y === 2017) return "RAM";
  if (type === "SR" && y >= 2017 && y <= 2024) return "RAM";
  if (["TP","TR"].includes(type) && y >= 2017 && y <= 2023) return "RAM";
  if (["WC","WR"].includes(type) && y >= 2017 && y <= 2023) return "RAM";
  if (type === "CrlMP" && y >= 2004 && y <= 2016) return "JAI";
  if (type === "SR" && (y <= 2016 || y >= 2025)) return "JAI";
  if (["TP","TR"].includes(type) && (y <= 2016 || y >= 2024)) return "JAI";
  if (["WC","WR"].includes(type) && (y <= 2016 || y >= 2024)) return "JAI";
  if (type === "D.R" && y >= 2024 && y <= 2026) return "JAI";
  if (type === "D.C" && y <= 2023) return "RAJ";
  if (type === "D.R" && y <= 2023) return "RAJ";
  if (type === "SC" && y <= 2019) return "RAJ";
  if (type === "SC" && y >= 2020 && y <= 2024) return "LAX";
  if (type === "SC" && (y === 2025 || y === 2026)) return "PIN";
  if (type === "D.C" && y >= 2024 && y <= 2026) return "PIN";
  if (type === "AP" && (y === 2025 || y === 2026)) return "PIN";
  if (type === "CA") return "RAV";
  if (type === "AR") return "RAV";
  return "";
}

// â”€â”€â”€ Main parser â”€â”€â”€
function parseAll(raw) {
  const courts = {};
  let currentCourt = null;
  const lines = joinLines(raw);

  // Preprocess: clean unicode, tabs, etc.
  const cleanLines = lines.map(l => {
    return l
      .replace(/\u200b|\u200c|\u200d/g, '')
      .replace(/\u202f|\u00a0/g, ' ')
      .replace(/\t/g, ' ')
      .replace(/\u2018|\u2019/g, "'")
      .replace(/\u201c|\u201d/g, '"')
      .replace(/ +/g, ' ');
  });

  for (let i = 0; i < cleanLines.length; i++) {
    const line = cleanLines[i];
    const stripped = line.trim();
    if (!stripped) continue;

    // Court header
    const courtNo = detectCourt(stripped);
    if (courtNo !== null) {
      currentCourt = courtNo;
      if (!courts[currentCourt]) courts[currentCourt] = [];
      continue;
    }

    // Skip section headers
    if (stripped.startsWith('[') && stripped.endsWith(']')) continue;
    // Skip IA lines
    if (/^IA\s+No\./i.test(stripped)) continue;

    // Sub-item
    let sno, rest;
    const mSub = stripped.match(/^\s*(\d+)\s*\.\s*([1-5])(?:\s+Connected)?\s+(.+)/);
    if (mSub) {
      sno = `${mSub[1]}.${mSub[2]}`;
      rest = mSub[3];
    } else {
      const mMain = stripped.match(/^(\d+)\.?\s+(.+)/);
      if (mMain) {
        sno = mMain[1];
        rest = mMain[2];
        // Skip lines whose "rest" is purely a section label, "Connected", or similar noise â€” not actual case entries
        if (/^(Connected|PIL-[WC]|(?:X{1,3}(?:IX|IV|V?I{0,3})|IX|IV|V?I{1,3}|V)(?:-[A-Z])?)\s*$/i.test(rest)) continue;
      } else continue;
    }

    // Nested case?
    const nested = detectNestedCase(rest);
    let caseType, numInt, caseNoStr, year;

    if (nested && nested.outerType !== 'IA') {
      const innerDisplay = `${nested.innerNum}/${nested.innerYear}`;
      caseType   = `${nested.outerType} in ${nested.innerType} ${innerDisplay}`;
      numInt     = nested.outerNum;
      caseNoStr  = String(nested.outerNum);
      year       = nested.outerYear;
    } else {
      const [ct, typeEnd] = detectCaseType(rest);
      if (ct === "Unknown" || typeEnd === null) continue;
      if (ct === "IA") continue; // IA is never a standalone case entry
      const [ni, cns, yr] = extractCaseNumber(rest, typeEnd);
      if (cns === "Unknown") continue;
      caseType = ct; numInt = ni; caseNoStr = cns; year = yr;
    }

    // Section
    let section = '';
    // sectionPat: Roman numerals (I to XXX) with optional letter suffix, or PIL-W/PIL-C
    // Explicit list to avoid matching empty strings from V?I{0,3}
    const ROMAN_CORE = '(?:X{1,3}(?:IX|IV|V?I{0,3})|IX|IV|V?I{1,3}|V)';
    const sectionPat = new RegExp('^(PIL-[WC]|' + ROMAN_CORE + ')(-[A-Z])?$', 'i');
    const SECTION_INLINE = new RegExp('(PIL-[WC]|' + ROMAN_CORE + '(?:-[A-Z])?)', 'i');
    // First check: trailing section token on the rest line itself (e.g. "MA 278/2026 in C.A. 10930/2018 XVII")
    const trailingSecM = rest.match(new RegExp('\\s+(' + ROMAN_CORE + '(?:-[A-Z])?|PIL-[WC])\\s*$', 'i'));
    if (trailingSecM && trailingSecM[1].length > 0) { section = trailingSecM[1]; }
    // Then check subsequent lines if not found yet
    // Look up to 10 lines ahead; allow passing over blank lines and party-name lines
    // but stop once we hit the NEXT numbered item
    if (!section) {
      for (let j = i+1; j < Math.min(i+15, cleanLines.length); j++) {
        const nl = cleanLines[j].trim();
        if (!nl) continue;
        const cl = nl.replace(/\(SCLSC\)/g, '').trim();
        // Exact section match (whole line is section code)
        if (cl.length > 0 && sectionPat.test(cl)) { section = cl; break; }
        // Section at START of line followed by any whitespace + letter (party name) or end of line
        // e.g. "III-A  AUTHORITY" or "XII-A MULKALA..." (single space before name is fine)
        // Guard: what follows must start with a letter (not a digit like a case/year number)
        const mSec = cl.match(new RegExp('^(PIL-[WC]|' + ROMAN_CORE + '(?:-[A-Z])?)(?:\\s+[A-Z]|\\s*$)', 'i'));
        if (mSec && mSec[1].length > 0) { section = mSec[1]; break; }
        // Section at END of a party-name line (e.g. "AUTHORITY FOR ADVANCE RULINGS  II")
        const mSecEnd = cl.match(new RegExp('\\s+(PIL-[WC]|' + ROMAN_CORE + '(?:-[A-Z])?)\\s*$', 'i'));
        if (mSecEnd && mSecEnd[1].length > 0 && !/^\d+[\/\-]\d{4}/.test(cl)) {
          section = mSecEnd[1]; break;
        }
        // Stop at next numbered item only â€” do NOT break on "Versus"
        // because section label often appears after petitioner/respondent lines
        if (/^\d+\.?\s+/.test(nl)) break;
      }
    }

    // Diary type
    let finalType = caseType;
    if (caseType === "D") {
      finalType = (section && (/^II(-[A-E])?$/i.test(section) || section.toUpperCase() === 'X')) ? "D.R" : "D.C";
    }

    const godown = assignGodown(finalType, year, section);

    if (currentCourt === null) { currentCourt = 0; courts[0] = courts[0] || []; }

    courts[currentCourt].push({
      Item_No: sno, Case_No: caseNoStr, Case_No_Int: numInt,
      Year: year, Type: finalType, Section: section, Godown: godown, Court: currentCourt
    });
  }

  // Sort each court by case number
  for (const c of Object.keys(courts)) {
    courts[c].sort((a,b) => a.Case_No_Int - b.Case_No_Int);
  }
  return courts;
}

// â”€â”€â”€ PDF generation (A4 portrait, pure B&W, maximum density) â”€â”€â”€
function generatePDF(title, entries, date, subtitle) {
  const { jsPDF } = window.jspdf;

  const doc  = new jsPDF({ orientation: 'p', unit: 'mm', format: 'a4' });
  const W = 210, H = 297;
  const ML = 6, MR = 6, MT = 5, MB = 6;   // tight margins: left/right/top/bottom
  const BLACK = [0,0,0], WHITE = [255,255,255];

  // â”€â”€ Columns: span full usable width (210 - 6 - 6 = 198mm) â”€â”€
  // S.NO | TYPE | CASE NO | YEAR | SEC | GDN
  // 13   | 80   | 52      | 14   | 20  | 19   = 198mm
  const colW    = [18, 67, 60, 14, 20, 19];  // CASE NO widened, TYPE trimmed
  const colX    = colW.map((_, i) => ML + colW.slice(0, i).reduce((a,b) => a+b, 0));
  const headers = ['S.NO.', 'TYPE', 'CASE NO.', 'YEAR', 'SECTION', 'GODOWN'];

  const tableWidth = colW.reduce((a,b) => a+b, 0);   // 198mm
  const tableRight = ML + tableWidth;

  // â”€â”€ Typography: small but crisp â”€â”€
  const FS       = 11;     // data font size (pt)
  const FS_HDR   = 11;     // column header font size
  const LINE_H   = 4.5;    // mm per line at FS 11
  const ROW_PAD  = 1.8;    // total vertical padding per row (split top+bottom)
  const COL_PAD  = 1.5;    // horizontal text inset from cell edge

  // â”€â”€ Page header block height â”€â”€
  // Title row + subtitle row + thin rule = 14mm
  const PG_HDR_H  = 6;   // just a single date line on page 1
  const PG_FTR_H  = 0;   // no footer â€” use full page height
  const tableTopY = MT + PG_HDR_H;
  const tableBottomY = H - MB - PG_FTR_H;

  // â”€â”€ Column header row height (bold, one line) â”€â”€
  const COL_HDR_H = LINE_H + ROW_PAD + 1;  // ~5.4mm

  // â”€â”€ Measure lines needed for a value in column colIdx â”€â”€
  function lineCount(val, colIdx) {
    doc.setFont('helvetica', 'normal');
    doc.setFontSize(FS);
    return doc.splitTextToSize(val, colW[colIdx] - COL_PAD * 2).length;
  }

  // â”€â”€ Row height for one entry â”€â”€
  function rowHeight(e) {
    // Strip the /YEAR suffix from Case_No â€” year is already in its own column
    const rawCaseNo = String(e.Case_No).replace(/\/\d{4}$/, '');
    const vals = [
      String(e.Item_No), String(e.Type), rawCaseNo,
      String(e.Year), String(e.Section || ''), String(e.Godown || '')
    ];
    const maxL = Math.max(...vals.map((v,i) => lineCount(v,i)));
    return maxL * LINE_H + ROW_PAD;
  }

  // â”€â”€ Draw the page-level header (title block) â”€â”€
  function drawPageHeader(pageIdx, totalPages) {
    // Only print the date on the very first page, small and unobtrusive
    if (pageIdx === 1) {
      doc.setFont('helvetica', 'normal');
      doc.setFontSize(7);
      doc.setTextColor(...BLACK);
      doc.text('Date: ' + date, ML, MT + 4);
    }
    // No rule, no title, no institution name â€” the column header says it all
  }

  // â”€â”€ Draw column header row (black fill, white text, full grid) â”€â”€
  function drawColHeader(y) {
    // Black fill
    doc.setFillColor(...BLACK);
    doc.rect(ML, y, tableWidth, COL_HDR_H, 'F');

    doc.setFont('helvetica', 'bold');
    doc.setFontSize(FS_HDR);
    doc.setTextColor(...WHITE);

    headers.forEach((h, i) => {
      const textY = y + COL_HDR_H / 2 + LINE_H / 2 - 0.3;
      const cellCX = colX[i] + colW[i] / 2;
      doc.text(h, cellCX, textY, { align: 'center', maxWidth: colW[i] - COL_PAD * 2 });
    });

    // Vertical dividers inside header
    doc.setDrawColor(...WHITE);
    doc.setLineWidth(0.25);
    for (let i = 1; i < colX.length; i++) {
      doc.line(colX[i], y, colX[i], y + COL_HDR_H);
    }

    doc.setTextColor(...BLACK);
    return y + COL_HDR_H;
  }

  // â”€â”€ Draw one data row â€” pure B&W, full border on every cell â”€â”€
  function drawRow(e, y, rh) {
    const caseNoDisplay = String(e.Case_No).replace(/\/\d{4}$/, '');
    const vals = [
      String(e.Item_No), String(e.Type), caseNoDisplay,
      String(e.Year), String(e.Section || ''), String(e.Godown || '')
    ];

    doc.setFont('helvetica', 'normal');
    doc.setFontSize(FS);
    doc.setTextColor(...BLACK);
    doc.setDrawColor(...BLACK);

    vals.forEach((val, i) => {
      // CASE NO. (index 2) gets larger bold font; all others use standard FS
      if (i === 2) {
        doc.setFont('helvetica', 'bold');
        doc.setFontSize(12);
      } else {
        doc.setFont('helvetica', 'normal');
        doc.setFontSize(FS);
      }
      const lines = doc.splitTextToSize(val, colW[i] - COL_PAD * 2);
      const textY = lines.length === 1
        ? y + rh / 2 + LINE_H / 2 - 0.3
        : y + LINE_H + ROW_PAD / 2;
      const cellCX = colX[i] + colW[i] / 2;
      doc.text(lines, cellCX, textY, { align: 'center', maxWidth: colW[i] - COL_PAD * 2 });
    });
    // Reset font after row
    doc.setFont('helvetica', 'normal');
    doc.setFontSize(FS);

    // Horizontal bottom border of row
    doc.setLineWidth(0.15);
    doc.line(ML, y + rh, tableRight, y + rh);

    // Vertical column dividers for this row
    doc.setLineWidth(0.15);
    for (let i = 1; i < colX.length; i++) {
      doc.line(colX[i], y, colX[i], y + rh);
    }

    return y + rh;
  }

  // â”€â”€ Close page: draw outer rect and left border â”€â”€
  function closePage(tableStart, tableEnd) {
    doc.setDrawColor(...BLACK);
    doc.setLineWidth(0.5);
    doc.rect(ML, tableStart, tableWidth, tableEnd - tableStart, 'S');
  }

  // â”€â”€ Pre-compute row heights â”€â”€
  const rowHeights = entries.map(e => rowHeight(e));

  // â”€â”€ Pass 1: count total pages â”€â”€
  let totalPages = 0;
  {
    let curY = tableTopY + COL_HDR_H;
    for (let i = 0; i < rowHeights.length; i++) {
      if (curY + rowHeights[i] > tableBottomY) {
        totalPages++;
        curY = tableTopY + COL_HDR_H;
      }
      curY += rowHeights[i];
    }
    totalPages++;
  }

  // â”€â”€ Pass 2: render â”€â”€
  let pageIdx   = 1;
  let tableStartY = tableTopY;

  drawPageHeader(pageIdx, totalPages);
  let y = drawColHeader(tableTopY);
  tableStartY = tableTopY;

  for (let i = 0; i < entries.length; i++) {
    const rh = rowHeights[i];

    if (y + rh > tableBottomY) {
      closePage(tableStartY, y);
      doc.addPage();
      pageIdx++;

      drawPageHeader(pageIdx, totalPages);
      y = drawColHeader(tableTopY);
      tableStartY = tableTopY;
    }

    y = drawRow(entries[i], y, rh);
  }

  closePage(tableStartY, y);
  return doc;
}

// â”€â”€â”€ Stored PDFs for download-all â”€â”€â”€
let storedPDFs = { court: {}, godown: {} };

function downloadPDF(type, key) {
  const pdf = storedPDFs[type][key];
  if (pdf) pdf.save(`${key.replace(/ /g,'_')}.pdf`);
}

function downloadAll(type) {
  for (const key of Object.keys(storedPDFs[type])) {
    storedPDFs[type][key].save(`${key.replace(/ /g,'_')}.pdf`);
  }
}

// â”€â”€â”€ Main run â”€â”€â”€
function runParse() {
  const raw = textInput.value.trim();
  if (!raw) {
    showStatus('Please paste text or upload a file first.', 'error');
    return;
  }

  document.getElementById('results').classList.remove('visible');
  document.getElementById('statusBar').className = 'status-bar';
  document.getElementById('processing').classList.add('visible');
  document.getElementById('parseBtn').disabled = true;

  setTimeout(() => {
    try {
      documentDate = extractDate(raw);
      parsedCourts = parseAll(raw);

      // Build godowns
      parsedGodowns = {};
      for (const courtEntries of Object.values(parsedCourts)) {
        for (const e of courtEntries) {
          const g = e.Godown || 'MIS';
          if (!parsedGodowns[g]) parsedGodowns[g] = [];
          parsedGodowns[g].push(e);
        }
      }
      // Sort godown entries by type count
      for (const g of Object.keys(parsedGodowns)) {
        const typeCounts = {};
        for (const e of parsedGodowns[g]) typeCounts[e.Type] = (typeCounts[e.Type]||0)+1;
        parsedGodowns[g].sort((a,b) => typeCounts[a.Type]-typeCounts[b.Type] || a.Type.localeCompare(b.Type) || parseInt(a.Year)-parseInt(b.Year) || a.Case_No_Int-b.Case_No_Int);
      }

      const totalCases = Object.values(parsedCourts).reduce((s,a)=>s+a.length,0);
      if (totalCases === 0) throw new Error('No cases found. Check your input text.');

      // Stats
      document.getElementById('statCases').textContent = totalCases;
      document.getElementById('statCourts').textContent = Object.keys(parsedCourts).length;
      document.getElementById('statGodowns').textContent = Object.keys(parsedGodowns).length;

      // Check jsPDF is available before generating
      if (typeof window.jspdf === 'undefined') {
        throw new Error(
          'jsPDF library could not load â€” Brave Shields may be blocking CDN scripts. ' +
          'To fix: click the Brave Shields icon (ðŸ›¡) in the address bar and disable shields for this page, then reload. ' +
          'Or try opening this file in Chrome/Edge.'
        );
      }

      // Generate court PDFs
      storedPDFs = { court: {}, godown: {} };
      const courtGrid = document.getElementById('courtGrid');
      courtGrid.innerHTML = '';
      const courtKeys = Object.keys(parsedCourts).map(Number).sort((a,b)=>a-b);
      courtKeys.forEach((c, idx) => {
        const entries = parsedCourts[c];
        const key = `Court_${c}_${documentDate}`;
        const pdf = generatePDF(`COURT NO. ${c}`, entries, documentDate, `${entries.length} cases`);
        storedPDFs.court[key] = pdf;
        const card = document.createElement('div');
        card.className = 'pdf-card';
        card.style.animationDelay = `${idx * 0.05}s`;
        card.innerHTML = `<span class="pdf-icon"><svg width="22" height="22" viewBox="0 0 22 22" fill="none" xmlns="http://www.w3.org/2000/svg"><!-- Pediment / roof triangle --><polygon points="11,2 20,7 2,7" fill="none" stroke="#e0e0e0" stroke-width="1.2" stroke-linejoin="round"/><!-- Frieze bar --><rect x="2" y="7" width="18" height="2" rx="0.4" fill="#e0e0e0"/><!-- Three pillars --><rect x="4.5" y="9" width="1.5" height="7" rx="0.4" fill="#888"/><rect x="10.25" y="9" width="1.5" height="7" rx="0.4" fill="#888"/><rect x="16" y="9" width="1.5" height="7" rx="0.4" fill="#888"/><!-- Base / steps --><rect x="1.5" y="16" width="19" height="1.5" rx="0.4" fill="#e0e0e0"/><rect x="0.5" y="17.5" width="21" height="1.5" rx="0.4" fill="#555"/></svg></span><span class="pdf-name">COURT ${c}</span><span class="pdf-count">${entries.length} cases</span>`;
        card.onclick = () => openModal('court', key, `COURT NO. ${c}`);
        courtGrid.appendChild(card);
      });

      // Generate godown PDFs
      const godownGrid = document.getElementById('godownGrid');
      godownGrid.innerHTML = '';
      const godownKeys = Object.keys(parsedGodowns).sort();
      godownKeys.forEach((g, idx) => {
        const entries = parsedGodowns[g];
        const key = `Godown_${g}_${documentDate}`;
        const pdf = generatePDF(`GODOWN: ${g}`, entries, documentDate, `${entries.length} cases`);
        storedPDFs.godown[key] = pdf;
        const card = document.createElement('div');
        card.className = 'pdf-card godown';
        card.style.animationDelay = `${idx * 0.05}s`;
        card.innerHTML = `<span class="pdf-icon"><svg width="22" height="22" viewBox="0 0 22 22" fill="none" xmlns="http://www.w3.org/2000/svg"><!-- Roof --><polygon points="11,2 21,7 1,7" fill="none" stroke="#e0e0e0" stroke-width="1.2" stroke-linejoin="round"/><!-- Walls --><rect x="1" y="7" width="20" height="13" rx="0.5" fill="none" stroke="#888" stroke-width="1.2"/><!-- Shelf lines --><line x1="1" y1="11" x2="21" y2="11" stroke="#555" stroke-width="1"/><line x1="1" y1="15" x2="21" y2="15" stroke="#555" stroke-width="1"/><!-- Small boxes on shelves --><rect x="3" y="8.5" width="3" height="2.5" rx="0.3" fill="#555"/><rect x="7" y="8.5" width="2.5" height="2.5" rx="0.3" fill="#444"/><rect x="13" y="8.5" width="3" height="2.5" rx="0.3" fill="#555"/><rect x="3" y="12" width="2.5" height="3" rx="0.3" fill="#444"/><rect x="7.5" y="12" width="3.5" height="3" rx="0.3" fill="#555"/><rect x="14" y="12" width="2.5" height="3" rx="0.3" fill="#444"/><!-- Door --><rect x="8.5" y="16" width="5" height="4" rx="0.4" fill="none" stroke="#888" stroke-width="1"/></svg></span><span class="pdf-name">${g}</span><span class="pdf-count">${entries.length} cases</span>`;
        card.onclick = () => openModal('godown', key, `GODOWN: ${g}`);
        godownGrid.appendChild(card);
      });

      document.getElementById('processing').classList.remove('visible');
      document.getElementById('results').classList.add('visible');
      document.getElementById('parseBtn').disabled = false;

    } catch(err) {
      document.getElementById('processing').classList.remove('visible');
      document.getElementById('parseBtn').disabled = false;
      showStatus(`Error: ${err.message}`, 'error');
    }
  }, 50);
}

function showStatus(msg, type) {
  const bar = document.getElementById('statusBar');
  bar.textContent = msg;
  bar.className = `status-bar ${type}`;
}

// â”€â”€â”€ Modal â”€â”€â”€
let currentModalType = null, currentModalKey = null;

function openModal(type, key, title) {
  currentModalType = type;
  currentModalKey = key;

  document.getElementById('modalTitle').textContent = title;
  document.getElementById('modalOverlay').classList.add('open');
  document.getElementById('modalIframe').style.display = 'none';
  document.getElementById('modalLoading').style.display = 'flex';

  const pdf = storedPDFs[type][key];
  // Generate blob URL for inline viewing
  const blob = pdf.output('blob');
  const url = URL.createObjectURL(blob);

  const iframe = document.getElementById('modalIframe');
  iframe.onload = () => {
    document.getElementById('modalLoading').style.display = 'none';
    iframe.style.display = 'block';
  };
  // Append #toolbar=1&view=FitH for better inline viewing
  iframe.src = url + '#toolbar=1&view=FitH';

  // Fallback: if iframe doesn't load in 3s (mobile browsers block blob iframes), show download prompt
  setTimeout(() => {
    if (iframe.style.display === 'none') {
      document.getElementById('modalLoading').innerHTML = `
        <div style="text-align:center;padding:20px;">
          <div style="font-size:2rem;margin-bottom:12px;">ðŸ“±</div>
          <div style="color:var(--text);margin-bottom:8px;font-size:0.85rem;">Inline preview not supported on this browser.</div>
          <div style="color:var(--muted);font-size:0.72rem;margin-bottom:16px;">Tap Download to save and view the PDF.</div>
          <button class="modal-btn download" onclick="modalDownload()" style="font-size:0.85rem;padding:10px 20px;">â¬‡ Download PDF</button>
        </div>`;
    }
  }, 3000);
}

function closeModal() {
  document.getElementById('modalOverlay').classList.remove('open');
  const iframe = document.getElementById('modalIframe');
  // Revoke old blob URL to free memory
  if (iframe.src && iframe.src.startsWith('blob:')) URL.revokeObjectURL(iframe.src);
  iframe.src = '';
  iframe.style.display = 'none';
  document.getElementById('modalLoading').style.display = 'flex';
  document.getElementById('modalLoading').innerHTML = `<div class="spinner"></div>Rendering PDF...`;
}

function closeModalOnOverlay(e) {
  if (e.target === document.getElementById('modalOverlay')) closeModal();
}

function modalDownload() {
  if (currentModalType && currentModalKey) downloadPDF(currentModalType, currentModalKey);
}

// Close modal on Escape key
document.addEventListener('keydown', e => { if (e.key === 'Escape') closeModal(); });

// â”€â”€â”€ Startup library check (non-blocking â€” just warns) â”€â”€â”€
window.addEventListener('load', () => {
  // Give dynamic scripts a moment to settle
  setTimeout(() => {
    const jspdfOk = typeof window.jspdf !== 'undefined';
    const pdfjsOk = typeof pdfjsLib !== 'undefined';
    if (!jspdfOk || !pdfjsOk) {
      const msgs = [];
      if (!jspdfOk) msgs.push('PDF generation (jsPDF) failed to load');
      if (!pdfjsOk) msgs.push('PDF upload (PDF.js) failed to load');
      showStatus(
        'âš  ' + msgs.join(' Â· ') + '. ' +
        'Brave Shields may be blocking scripts â€” click the ðŸ›¡ icon in the address bar and turn off shields for this page, then reload.',
        'error'
      );
    }
  }, 2000);
});
</script>
</body>
</html>
